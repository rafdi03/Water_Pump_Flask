<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ESP32 Data Monitoring</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet" />
  </head>
  <body>
    <div class="container mt-5">
      <div class="row">
        <div class="col-lg-4"></div>
        <div class="col-lg-4 text-center">
          <h1>Data Monitoring Status Pompa</h1>
          <div class="chart-container">
            <canvas id="dataChart"></canvas>
          </div>
        </div>
        <div class="col-lg-4">
          <div class="form-check form-switch justify-content-end">
            <input class="form-check-input" type="checkbox" role="switch" id="pumpSwitch" {% if pump_status == "ON" %}checked{% endif %} onchange="togglePumpState(this.checked)">
            <label class="form-check-label" for="pumpSwitch">Toggle Pump</label>
          </div>
        </div>
      </div>
      <div class="row">
        <div class="col-lg-6">
          <table class="table mt-5" id="dataTable">
            <thead>
              <tr>
                <th scope="col">Timestamp</th>
                <th scope="col">Kekeruhan Air</th>
                <th scope="col">Status Pompa</th>
              </tr>
            </thead>
            <tbody>
              {% for entry in data %}
              <tr>
                <td>{{ entry.Timestamp }}</td>
                <td>{{ entry.Kekeruhan_Air }}</td>
                <td>{{ entry.Status_Pompa }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        <div class="col-lg-6">
          <table class="table mt-5" id="dataTableStatusPompa">
            <thead>
              <tr>
                <th scope="col">Timestamp</th>
                <th scope="col">Status Pompa</th>
              </tr>
            </thead>
            <tbody>
              {% for entry in data_status_pompa %}
              <tr>
                <td>{{ entry.Timestamp }}</td>
                <td>{{ entry.Status_Pompa }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Socket.IO JavaScript -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.3.2/socket.io.js"></script>
    <script>
      var socket = io.connect("http://" + document.domain + ":" + location.port);
      var chart; // Global reference to the chart instance

      // Function to toggle pump state
      function togglePumpState(checked) {
        var newState = checked ? "ON" : "OFF";
        fetch("/control_state", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ state: newState }),
        })
          .then((response) => {
            if (response.ok) {
              console.log("Pump state changed successfully");
            } else {
              console.error("Failed to change pump state");
            }
          })
          .catch((error) => console.error("Error:", error));
      }

      // Function to create or update the chart
      function createOrUpdateChart(data) {
        const ctx = document.getElementById("dataChart").getContext("2d");
        const timestamps = data.map((entry) => entry.Timestamp);
        const kekeruhanAir = data.map((entry) => entry.Kekeruhan_Air);

        if (chart) {
          // Update chart data
          chart.data.labels = timestamps;
          chart.data.datasets[0].data = kekeruhanAir;
          chart.update();
        } else {
          // Create a new chart
          chart = new Chart(ctx, {
            type: "line",
            data: {
              labels: timestamps,
              datasets: [
                {
                  label: "Kekeruhan Air",
                  data: kekeruhanAir,
                  fill: false,
                  borderColor: "rgb(75, 192, 192)",
                  tension: 0.1,
                },
              ],
            },
            options: {
              scales: {
                x: { title: { display: true, text: "Timestamp" } },
                y: { title: { display: true, text: "Kekeruhan Air" } },
              },
            },
          });
        }
      }

      // Function to update the table
      function updateTable(data) {
        const tableBody = document.querySelector("#dataTable tbody");
        tableBody.innerHTML = "";
        data.forEach((entry) => {
          const row = document.createElement("tr");
          row.innerHTML = `<td>${entry.Timestamp}</td><td>${entry.Kekeruhan_Air}</td><td>${entry.Status_Pompa}</td>`;
          tableBody.appendChild(row);
        });
      }

      // Socket.IO event listeners
      socket.on("connect", function () {
        // Request initial data upon connection
        socket.emit("request data");
      });

      function updateStatusPompaTable(dataStatusPompa) {
        const tableBodyStatusPompa = document.querySelector("#dataTableStatusPompa tbody");
        tableBodyStatusPompa.innerHTML = "";
        dataStatusPompa.forEach((entry) => {
          const row = document.createElement("tr");
          row.innerHTML = `<td>${entry.Timestamp}</td><td>${entry.Status_Pompa}</td>`;
          tableBodyStatusPompa.appendChild(row);
        });
      }

      // Adjusted to handle both data and data_status_pompa
      socket.on("update data", function (message) {
        const data = message.data; // Data for the Kekeruhan Air
        const dataStatusPompa = message.data_status_pompa; // Data for the Status Pompa
        console.log("Kekeruhan Air updated:", data);
        console.log("Status Pompa updated:", dataStatusPompa);
        updateTable(data); // Update the first table
        updateStatusPompaTable(dataStatusPompa); // Update the second table
        createOrUpdateChart(data); // Only the first dataset affects the chart
      });

      socket.on("pump status", function (data) {
        // Update pump status
        console.log("Pump status:", data);
      });
    </script>
  </body>
</html>
